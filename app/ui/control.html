<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>LLM Control Panel</title>
  <style>
    :root {--bg:#0b1020;--card:#111735;--ink:#e9edf7;--muted:#aab7ff;--line:#1f2a56;--accent:#2d47ff;}
    *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.45 system-ui,Segoe UI,Arial}
    header{padding:14px 16px;background:var(--card);position:sticky;top:0;z-index:1;border-bottom:1px solid var(--line)}
    h1{margin:0;font-size:18px}
    main{padding:16px;display:grid;gap:16px;grid-template-columns:1fr;max-width:1100px;margin:auto}
    .card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:14px}
    label{display:block;font-size:12px;color:var(--muted);margin:4px 0}
    input,textarea{width:100%;background:#0e1530;color:var(--ink);border:1px solid #223069;border-radius:10px;padding:10px 12px}
    textarea{min-height:120px;resize:vertical}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    button{background:var(--accent);color:#fff;border:none;border-radius:10px;padding:10px 14px;cursor:pointer;font-weight:600}
    button.secondary{background:#0e1530;border:1px solid #223069;color:#c9d6ff}
    code,kbd{background:#0e1530;border:1px solid #223069;border-radius:6px;padding:1px 6px}
    pre{margin:8px 0;background:#0a112a;border:1px solid #1a2553;border-radius:8px;padding:10px;overflow:auto;max-height:320px}
    .muted{color:var(--muted)}
    .cols{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    @media (max-width:900px){.cols{grid-template-columns:1fr}}
    .pill{display:inline-block;padding:6px 10px;border:1px solid #223069;border-radius:999px;color:#aab7ff;text-decoration:none;margin-right:8px;background:#0e1530}
  </style>
</head>
<body>
<header>
  <div class="row">
    <a class="pill" href="/ui/assistant.html">üí¨ Assistant</a>
    <a class="pill" href="/ui/bekendmakingen.html">‚öôÔ∏è Bekendmakingen</a>
  </div>
  <h1>LLM Control Panel</h1>
</header>

<main>
  <!-- INSTELLINGEN -->
  <section class="card">
    <h3>Instellingen</h3>
    <div class="cols">
      <div>
        <label>API Base URL</label>
        <input id="baseInput" placeholder="https://llm-cloud-starter.onrender.com" />
      </div>
      <div>
        <label>X-API-Key</label>
        <input id="keyInput" placeholder="plak hier je X-API-Key" />
      </div>
    </div>
    <div class="row" style="margin-top:10px">
      <button id="saveBtn">Opslaan</button>
      <button class="secondary" id="healthBtn">Health check</button>
      <span id="healthOut" class="muted"></span>
    </div>
  </section>

  <!-- SNELLE TEST -->
  <section class="card">
    <h3>Snelle test (job ‚Äúsummarize‚Äù)</h3>
    <label>Tekst</label>
    <textarea id="quickText" placeholder="Typ wat tekst die samengevat mag worden‚Ä¶"></textarea>
    <div class="row">
      <button id="quickBtn">Start test</button>
      <span id="quickOut" class="muted"></span>
    </div>
  </section>

  <!-- VRIJE INSTRUCTIE / BUILDER -->
  <section class="card">
    <h3>Vrije instructie ‚Üí <code>build_from_spec</code></h3>
    <p class="muted">
      Schrijf hier in gewone taal wat je wilt dat de API bouwt (je mag ook direct een
      JSON ‚Äúspec‚Äù plakken). We sturen dit door als <code>payload.spec</code> naar
      <code>task: "build_from_spec"</code>.
    </p>
    <label>Je instructie of JSON (spec)</label>
    <textarea id="specText" placeholder='Bijv: "Bouw een eenvoudige HTML pagina ..." of {"summary":"...","files":[...]} '></textarea>
    <div class="row">
      <button id="buildBtn">Bouwen & committen</button>
      <span id="buildOut" class="muted"></span>
    </div>
  </section>

  <!-- JOBS -->
  <section class="card">
    <div class="row" style="justify-content:space-between">
      <h3>Jobs</h3>
      <button class="secondary" id="jobsBtn">Ververs jobs</button>
    </div>
    <pre id="jobsOut" class="muted">Geen jobs geladen.</pre>
  </section>
</main>

<script>
  // ---------- helpers ----------
  const $ = (s) => document.querySelector(s);
  const saveLocal = (k, v) => localStorage.setItem(k, v);
  const readLocal = (k, d='') => localStorage.getItem(k) ?? d;
  const sleep = (ms) => new Promise(r => setTimeout(r, ms));
  const toast = (el, msg) => { el.textContent = msg; setTimeout(()=> el.textContent='', 2500); };

  // ---------- state ----------
  const baseInput = $('#baseInput');
  const keyInput  = $('#keyInput');

  function currentBase() {
    return (readLocal('baseUrl') || location.origin).replace(/\/+$/,'');
  }
  function currentKey() {
    return readLocal('x_api_key') || '';
  }

  async function apiGet(path) {
    const res = await fetch(currentBase() + path, {
      headers: {'X-API-Key': currentKey()}
    });
    return res;
  }

  async function apiPost(path, body) {
    const res = await fetch(currentBase() + path, {
      method: 'POST',
      headers: {'Content-Type':'application/json','X-API-Key': currentKey()},
      body: JSON.stringify(body)
    });
    return res;
  }

  // ---------- load settings ----------
  function loadSettings() {
    baseInput.value = readLocal('baseUrl') || location.origin;
    keyInput.value  = readLocal('x_api_key') || '';
  }

  // ---------- save settings (met directe veldupdate) ----------
  $('#saveBtn').onclick = () => {
    const base = baseInput.value.trim();
    const key  = keyInput.value.trim();
    saveLocal('baseUrl', base);
    saveLocal('x_api_key', key);
    // direct UI sync
    baseInput.value = base;
    keyInput.value = key;
    toast($('#healthOut'), 'Opgeslagen ‚úì');
  };

  // ---------- health ----------
  $('#healthBtn').onclick = async () => {
    const out = $('#healthOut');
    out.textContent = 'Bezig‚Ä¶';
    try {
      const r = await apiGet('/health');
      const txt = await r.text(); // kan text of json zijn
      out.textContent = r.ok ? `OK (${txt})` : `Fout ${r.status}`;
    } catch (e) {
      out.textContent = 'Netwerkfout: ' + e.message;
    }
  };

  // ---------- quick summarize ----------
  $('#quickBtn').onclick = async () => {
    const txt = $('#quickText').value.trim();
    const out = $('#quickOut');
    out.textContent = '';
    if (!txt) {
      out.textContent = 'Vul wat tekst in.';
      return;
    }
    try {
      const r = await apiPost('/jobs/create', {
        task: 'summarize',
        payload: { text: txt }
      });
      if (!r.ok) {
        out.textContent = 'Fout: ' + (await r.text());
        return;
      }
      const j = await r.json(); // { job_id: ... }
      out.textContent = 'Job gestart‚Ä¶ (' + j.job_id + ')';

      // pollen tot klaar
      while (true) {
        const d = await apiGet('/jobs/' + j.job_id).then(x => x.json());
        if (d.status === 'done' || d.status === 'failed' || d.status === 'error') {
          out.textContent = d.status === 'done'
            ? (d.result?.summary || JSON.stringify(d.result).slice(0,300))
            : 'Fout: ' + (d.error || d.result || d.status);
          break;
        }
        await sleep(800);
      }
    } catch (e) {
      out.textContent = 'Netwerkfout: ' + e.message;
    }
  };

  // ---------- builder: vrije instructie naar build_from_spec ----------
  $('#buildBtn').onclick = async () => {
    const specRaw = $('#specText').value.trim();
    const out = $('#buildOut');
    out.textContent = '';
    if (!specRaw) { out.textContent = 'Vul iets in (tekst of JSON).'; return; }

    // We sturen het altijd als { spec: <string of object> }
    let specPayload = specRaw;
    try {
      // als het geldige JSON is, als object meesturen
      specPayload = JSON.parse(specRaw);
    } catch (_) { /* laat als tekst */ }

    try {
      const r = await apiPost('/jobs/create', {
        task: 'build_from_spec',
        payload: { spec: specPayload }
      });
      if (!r.ok) {
        out.textContent = 'Fout: ' + (await r.text());
        return;
      }
      const j = await r.json();
      out.textContent = 'Build gestart‚Ä¶ (' + j.job_id + ')';

      // pollen tot klaar
      while (true) {
        const d = await apiGet('/jobs/' + j.job_id).then(x => x.json());
        if (d.status === 'done' || d.status === 'failed' || d.status === 'error') {
          const snip = JSON.stringify(d.result || d.error || d, null, 2);
          out.textContent = (d.status === 'done' ? 'Klaar: ' : 'Fout: ') + snip.slice(0, 600);
          break;
        }
        await sleep(1000);
      }
    } catch (e) {
      out.textContent = 'Netwerkfout: ' + e.message;
    }
  };

  // ---------- jobs overzicht ----------
  async function refreshJobs() {
    const out = $('#jobsOut');
    out.textContent = 'Bezig‚Ä¶';
    try {
      const r = await apiGet('/jobs');
      if (!r.ok) { out.textContent = 'Fout: ' + (await r.text()); return; }
      const j = await r.json(); // { id: jobObj, ... }
      const ids = Object.keys(j);
      if (!ids.length) { out.textContent = 'Geen jobs gevonden.'; return; }

      // toon top-10
      const lines = [];
      for (const id of ids.slice(0, 10)) {
        const job = j[id];
        const line = {
          id,
          task: job.task,
          status: job.status,
          created_at: job.created_at,
          result: (job.result && JSON.stringify(job.result).slice(0, 160)) || null,
          error: job.error || null
        };
        lines.push(line);
      }
      out.textContent = JSON.stringify(lines, null, 2);
    } catch (e) {
      out.textContent = 'Netwerkfout: ' + e.message;
    }
  }
  $('#jobsBtn').onclick = refreshJobs;

  // initial load
  loadSettings();
  // optioneel health check bij laden
  // $('#healthBtn').click();
</script>
</body>
</html>
