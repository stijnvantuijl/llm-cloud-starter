<!doctype html>
<html lang="nl">
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>LLM Control Panel</title>
<style>
  :root { color-scheme: dark; }
  body{font-family:system-ui,Segoe UI,Arial,sans-serif;background:#0b1020;color:#e9edf7;margin:0}
  header{padding:14px 16px;background:#111735;position:sticky;top:0;border-bottom:1px solid #1f2a56}
  h1{margin:0;font-size:18px}
  main{padding:16px;max-width:1200px;margin:auto}
  .grid{display:grid;gap:16px}
  @media(min-width:960px){ .grid{grid-template-columns:1.1fr .9fr} }
  .card{background:#121a3a;border:1px solid #1f2a56;border-radius:12px;padding:12px}
  label{font-size:12px;color:#aab7ff;display:block;margin:8px 0 4px}
  input,textarea,select{width:100%;box-sizing:border-box;background:#0e1530;color:#e9edf7;border:1px solid #223069;border-radius:10px;padding:10px 12px}
  textarea{min-height:160px;resize:vertical}
  button{background:#2d47ff;color:#fff;border:none;border-radius:10px;padding:10px 14px;cursor:pointer;font-weight:600}
  button.secondary{background:#0e1530;border:1px solid #223069;color:#c9d6ff}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-top:10px}
  pre{white-space:pre-wrap;word-break:break-word;background:#0e1530;border:1px solid #223069;border-radius:10px;padding:10px 12px;max-height:320px;overflow:auto}
  .muted{color:#9fb0ff;font-size:12px}
</style>
<header>
  <h1>LLM Control Panel</h1>
</header>
<main class="grid">
  <section class="card">
    <h3>Instellingen</h3>
    <label>API Base URL</label>
    <input id="baseUrl" placeholder="https://llm-cloud-starter.onrender.com" />
    <label>X-API-Key</label>
    <input id="apiKey" placeholder="plak je key hier" />
    <div class="row">
      <button id="saveBtn" type="button">Opslaan</button>
      <button id="healthBtn" class="secondary" type="button">Health check</button>
      <span id="saveOut" class="muted"></span>
    </div>
    <pre id="healthOut" class="muted"></pre>
  </section>

  <section class="card">
    <h3>Jobs</h3>
    <div class="row">
      <button id="refreshJobsBtn" class="secondary" type="button">Ververs jobs</button>
    </div>
    <pre id="jobsOut">-</pre>
  </section>

  <section class="card">
    <h3>Job composer (/jobs/create)</h3>
    <label>Template</label>
    <select id="tpl">
      <option value="">— kies template —</option>
      <option value='{"task":"weekly_bekendmakingen","payload":{"dry_run":true}}'>
        weekly_bekendmakingen (dry_run)
      </option>
      <option value='{"task":"commit_file","payload":{"repo":"<owner>/<repo>","branch":"main","path":"tmp/test_api.txt","message":"Test commit via API","content":"Hallo! Dit bestand is gecommit via de API."}}'>
        commit_file (voorbeeld)
      </option>
    </select>
    <label>JSON payload</label>
    <textarea id="payloadTxt" spellcheck="false">{ "task":"weekly_bekendmakingen", "payload": { "dry_run": true } }</textarea>
    <div class="row">
      <button id="sendBtn" type="button">Verstuur job</button>
      <button id="clearBtn" class="secondary" type="button">Leeg</button>
      <span id="sendOut" class="muted"></span>
    </div>
    <pre id="resultOut">-</pre>
    <p class="muted">Tip: payload moet geldige JSON zijn, bijv. <code>{"task":"…","payload":{…}}</code>.</p>
  </section>

  <section class="card">
    <h3>Selftest (beschikbare taken)</h3>
    <div class="row">
      <button id="selftestBtn" class="secondary" type="button">Selftest</button>
    </div>
    <pre id="selftestOut">-</pre>
  </section>
</main>

<script>
  // Helpers
  const $ = (s) => document.querySelector(s);
  const out = (el, v) => { el.textContent = (typeof v === 'string') ? v : JSON.stringify(v, null, 2); };

  // Load stored settings
  const baseUrlInput = $('#baseUrl');
  const apiKeyInput  = $('#apiKey');
  baseUrlInput.value = localStorage.getItem('baseUrl') || location.origin.replace(/\/ui.*/,'');
  apiKeyInput.value  = localStorage.getItem('x_api_key') || '';

  // Template → textarea
  $('#tpl').addEventListener('change', (e) => {
    if (!e.target.value) return;
    $('#payloadTxt').value = e.target.value;
  });

  // Save settings
  $('#saveBtn').addEventListener('click', () => {
    localStorage.setItem('baseUrl', baseUrlInput.value.trim());
    localStorage.setItem('x_api_key', apiKeyInput.value.trim());
    out($('#saveOut'), 'Opgeslagen');
    setTimeout(() => out($('#saveOut'), ''), 1500);
  });

  // Clear composer
  $('#clearBtn').addEventListener('click', () => {
    $('#payloadTxt').value = '';
    out($('#resultOut'), '-');
    out($('#sendOut'), '');
  });

  // Health
  $('#healthBtn').addEventListener('click', async () => {
    out($('#healthOut'), '⌛…');
    try{
      const r = await fetch((localStorage.getItem('baseUrl')||'') + '/health', {
        headers: { 'X-API-Key': localStorage.getItem('x_api_key') || '' }
      });
      const j = await r.json();
      out($('#healthOut'), j);
    }catch(e){
      out($('#healthOut'), 'Fout: ' + e.message);
    }
  });

  // Send job
  $('#sendBtn').addEventListener('click', async () => {
    const BASE = (localStorage.getItem('baseUrl')||'').trim();
    const KEY  = (localStorage.getItem('x_api_key')||'').trim();
    const txt  = $('#payloadTxt').value.trim();
    out($('#sendOut'), '');
    out($('#resultOut'), '⌛ versturen…');

    if (!BASE || !KEY) {
      out($('#resultOut'), 'Fout: Base URL of API-key ontbreekt. Klik eerst Opslaan.');
      return;
    }
    let payload;
    try { payload = JSON.parse(txt); }
    catch(e){ out($('#resultOut'), 'JSON fout: ' + e.message); return; }

    try{
      const res = await fetch(BASE + '/jobs/create', {
        method: 'POST',
        headers: {'Content-Type':'application/json','X-API-Key': KEY},
        body: JSON.stringify(payload)
      });
      const j = await res.json().catch(()=> ({}));
      out($('#resultOut'), j);
      if (j.job_id) {
        out($('#sendOut'), 'Job gestart: ' + j.job_id + ' (polling…)');
        // poll until done/failed
        const poll = async () => {
          const r = await fetch(BASE + '/jobs/' + j.job_id, { headers: { 'X-API-Key': KEY } });
          const d = await r.json();
          out($('#resultOut'), d);
          if (d.status === 'running') setTimeout(poll, 1200);
          else out($('#sendOut'), 'Klaar: ' + d.status);
        };
        poll();
      } else if (j.detail) {
        out($('#sendOut'), 'Server detail: ' + j.detail);
      } else {
        out($('#sendOut'), 'Verstuurd');
      }
    }catch(e){
      out($('#resultOut'), 'Fout: ' + e.message);
    }
  });

  // List jobs (latest first)
  $('#refreshJobsBtn').addEventListener('click', async () => {
    const BASE = localStorage.getItem('baseUrl')||'';
    const KEY  = localStorage.getItem('x_api_key')||'';
    out($('#jobsOut'), '⌛…');
    try{
      const r = await fetch(BASE + '/jobs', { headers: { 'X-API-Key': KEY } });
      const j = await r.json();
      // toon als lijst van {id,status,task,created_at}
      const items = Object.entries(j || {}).map(([id, o]) => ({
        id, status: o.status, task: o.task, created_at: o.created_at
      }));
      out($('#jobsOut'), items.length ? items : '— geen jobs gevonden —');
    }catch(e){
      out($('#jobsOut'), 'Fout: ' + e.message);
    }
  });

  // Selftest (welke taken zijn er)
  $('#selftestBtn').addEventListener('click', async () => {
    const BASE = localStorage.getItem('baseUrl')||'';
    const KEY  = localStorage.getItem('x_api_key')||'';
    out($('#selftestOut'), '⌛…');
    try{
      const r = await fetch(BASE + '/health', { headers: { 'X-API-Key': KEY } });
      const j = await r.json();
      out($('#selftestOut'), j);
    }catch(e){
      out($('#selftestOut'), 'Fout: ' + e.message);
    }
  });
</script>
</html>
