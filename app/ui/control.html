<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>LLM Control Panel</title>
  <style>
    :root{
      --bg:#0b1020; --panel:#111735; --card:#121a3a; --line:#1f2a56;
      --txt:#e9edf7; --muted:#aab7ff; --accent:#2d47ff; --ok:#22c55e; --err:#ef4444;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--txt);font:14px/1.45 system-ui,Segoe UI,Arial,sans-serif}
    header{position:sticky;top:0;background:var(--panel);padding:14px 16px;border-bottom:1px solid var(--line);z-index:10}
    h1{margin:0;font-size:18px}
    main{padding:16px;display:grid;gap:16px;max-width:1100px;margin:auto}
    .grid{display:grid;gap:16px}
    .cols-2{grid-template-columns:1.1fr .9fr}
    .card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:12px}
    label{display:block;font-size:12px;color:var(--muted);margin:8px 0 6px}
    input,textarea,select{
      width:100%;background:#0e1530;color:var(--txt);border:1px solid var(--line);
      border-radius:10px;padding:10px 12px;font:inherit
    }
    textarea{min-height:160px;resize:vertical}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    button{
      background:var(--accent);color:#fff;border:none;border-radius:10px;
      padding:10px 14px;cursor:pointer;font-weight:600
    }
    button.secondary{background:#0e1530;color:#c9d6ff;border:1px solid var(--line)}
    .pill{display:inline-block;padding:6px 10px;border:1px solid var(--line);border-radius:999px;
      color:var(--muted);text-decoration:none;background:#0e1530;margin-right:8px}
    .muted{color:var(--muted)}
    .ok{color:var(--ok)}
    .err{color:var(--err)}
    pre{white-space:pre-wrap;background:#0e1530;border:1px solid var(--line);padding:8px;border-radius:8px;max-height:300px;overflow:auto}
    .list{border:1px solid var(--line);border-radius:8px;overflow:hidden}
    .list-item{padding:8px 10px;border-bottom:1px solid var(--line);cursor:pointer}
    .list-item:hover{background:#0e1530}
    .list-item:last-child{border-bottom:0}
    small.code{font-family:ui-monospace,Menlo,Consolas,monospace;color:#c9d6ff}
  </style>
</head>
<body>
<header>
  <a class="pill" href="/ui/assistant.html">üí¨ Assistant</a>
  <a class="pill" href="/ui/bekendmakingen.html">‚öôÔ∏è Bekendmakingen</a>
  <h1>LLM Control Panel</h1>
</header>

<main>
  <!-- Instellingen -->
  <section class="card">
    <h3>Instellingen</h3>
    <div class="grid cols-2">
      <div>
        <label>API Base URL</label>
        <input id="baseUrl" placeholder="https://llm-cloud-starter.onrender.com" />
      </div>
      <div>
        <label>X-API-Key</label>
        <input id="apiKey" placeholder="plak hier je key‚Ä¶" />
      </div>
    </div>
    <div class="row" style="margin-top:8px">
      <button id="saveBtn">Opslaan</button>
      <button id="healthBtn" class="secondary">Health check</button>
      <span id="sysMsg" class="muted"></span>
    </div>
  </section>

  <div class="grid cols-2">
    <!-- Job composer -->
    <section class="card">
      <h3>Job composer <small class="muted">(POST <span class="code">/jobs/create</span>)</small></h3>
      <label>Templates</label>
      <div class="row">
        <select id="tplSelect">
          <option value="">‚Äî kies template ‚Äî</option>
          <option value="weekly">weekly_bekendmakingen (dry run)</option>
          <option value="commit">commit_file (voorbeeldcommit)</option>
          <option value="build">build_from_spec (mini-spec)</option>
        </select>
        <button id="setTplBtn" class="secondary">Zet in editor</button>
        <button id="clearBtn" class="secondary">Leeg</button>
      </div>
      <label>JSON payload</label>
      <textarea id="payloadTxt" spellcheck="false" placeholder='{"task":"‚Ä¶","payload":{‚Ä¶}}'></textarea>
      <div class="row" style="margin-top:8px">
        <button id="sendBtn">Verstuur job</button>
        <button id="selftestBtn" class="secondary">Selftest (build_from_spec)</button>
        <span id="sendMsg" class="muted"></span>
      </div>
      <label>Resultaat</label>
      <pre id="resultOut">-</pre>
    </section>

    <!-- Jobs -->
    <section class="card">
      <h3>Jobs</h3>
      <div class="row" style="margin-bottom:8px">
        <button id="refreshJobs" class="secondary">Ververs jobs</button>
        <span class="muted">Na ‚ÄúVerstuur job‚Äù wordt automatisch gepolld.</span>
      </div>
      <div id="jobsList" class="list" aria-live="polite"></div>

      <div style="margin-top:12px">
        <label>Job detail</label>
        <pre id="jobDetail">-</pre>
      </div>
    </section>
  </div>

  <!-- Tips -->
  <section class="card">
    <h3>Tips</h3>
    <ul>
      <li>
        <span class="code">/jobs/create</span> verwacht een JSON-object: 
        <small class="code">{"task":"‚Ä¶","payload":{‚Ä¶}}</small>.
      </li>
      <li>API-key en Base URL worden lokaal bewaard (localStorage).</li>
      <li>Gebruik <em>Selftest</em> om te zien welke taken beschikbaar zijn (en of <span class="code">build_from_spec</span> aanwezig is).</li>
    </ul>
  </section>
</main>

<script>
  // ---------- Helpers ----------
  const $ = s => document.querySelector(s);
  const sleep = ms => new Promise(r => setTimeout(r, ms));

  function lsGet(k, fallback=""){ try { return localStorage.getItem(k) || fallback; } catch { return fallback; } }
  function lsSet(k, v){ try { localStorage.setItem(k, v); } catch {} }

  function getBase(){ return $('#baseUrl').value.trim() || location.origin.replace(/\\/ui.*/,''); }
  function getKey(){ return $('#apiKey').value.trim(); }

  async function api(path, body){
    const res = await fetch(getBase() + path, {
      method: 'POST',
      headers: {'Content-Type':'application/json','X-API-Key': getKey()},
      body: JSON.stringify(body||{})
    });
    if(!res.ok){
      const txt = await res.text();
      throw new Error(txt || res.status + ' ' + res.statusText);
    }
    return res.json();
  }
  async function get(path){
    const res = await fetch(getBase() + path, {
      headers: {'X-API-Key': getKey()}
    });
    if(!res.ok){
      const txt = await res.text();
      throw new Error(txt || res.status + ' ' + res.statusText);
    }
    return res.json();
  }

  function setMsg(el, msg, ok){
    el.textContent = msg;
    el.classList.remove('ok','err');
    if(ok===true) el.classList.add('ok');
    else if(ok===false) el.classList.add('err');
  }

  // ---------- Init ----------
  function loadSettings(){
    $('#baseUrl').value = lsGet('baseUrl', location.origin.replace(/\\/ui.*/,''));
    $('#apiKey').value  = lsGet('x_api_key','');
  }
  function saveSettings(){
    lsSet('baseUrl', $('#baseUrl').value.trim());
    lsSet('x_api_key', $('#apiKey').value.trim());
    setMsg($('#sysMsg'),'Opgeslagen.', true);
    setTimeout(()=> setMsg($('#sysMsg'),'') ,1500);
  }

  // ---------- Health ----------
  async function doHealth(){
    setMsg($('#sysMsg'),'Controleren‚Ä¶');
    try{
      const r = await get('/health');
      setMsg($('#sysMsg'),'OK (' + JSON.stringify(r) + ')', true);
    }catch(e){
      setMsg($('#sysMsg'),'Fout: ' + e.message, false);
    }
  }

  // ---------- Templates ----------
  function tplWeekly(){
    return JSON.stringify({
      task: "weekly_bekendmakingen",
      payload: { dry_run: true }
    }, null, 2);
  }
  function tplCommit(){
    return JSON.stringify({
      task: "commit_file",
      payload: {
        repo: lsGet('repo') || "stijnvantuijl/llm-cloud-starter",
        branch: lsGet('branch') || "main",
        path: "tmp/test_api.txt",
        message: "Test commit via API",
        content: "Hallo! Dit bestand is via de API gecommit. üöÄ\n"
      }
    }, null, 2);
  }
  function tplBuild(){
    return JSON.stringify({
      task: "build_from_spec",
      payload: {
        spec: {
          summary: "Bekendmakingen v1 UI + config",
          commit_message: "scaffold bekendmakingen ui+config+readme",
          files: [
            {
              path: "apps/bekendmakingen/configs/bekendmakingen.json",
              content: JSON.stringify({
                municipalities: [],
                keywords: ["Didam arrest","anterieure overeenkomst","grondverkoop","omgevingsvisie"],
                routes: [{ emails: [] }]
              }, null, 2) + "\n"
            }
          ]
        }
      }
    }, null, 2);
  }

  $('#setTplBtn').onclick = () => {
    const v = $('#tplSelect').value;
    if(!v) return;
    if(v==='weekly') $('#payloadTxt').value = tplWeekly();
    if(v==='commit') $('#payloadTxt').value = tplCommit();
    if(v==='build')  $('#payloadTxt').value = tplBuild();
  };
  $('#clearBtn').onclick = () => { $('#payloadTxt').value = ''; $('#resultOut').textContent='-'; };

  // ---------- Jobs ----------
  let pollTimer = null;

  async function refreshJobs(){
    try{
      const jobs = await get('/jobs');
      const listEl = $('#jobsList');
      listEl.innerHTML = '';
      const ids = Object.keys(jobs || {});
      if(ids.length===0){
        listEl.innerHTML = '<div class="list-item muted">Geen jobs</div>';
        return;
      }
      ids.forEach(id=>{
        const item = document.createElement('div');
        item.className = 'list-item';
        item.textContent = `${id} ‚Äî ${jobs[id].task || '?' } ‚Äî ${jobs[id].status || '?'}`;
        item.onclick = ()=> showJob(id);
        listEl.appendChild(item);
      });
    }catch(e){
      $('#jobsList').innerHTML = `<div class="list-item err">Fout: ${e.message}</div>`;
    }
  }

  async function showJob(id){
    $('#jobDetail').textContent = 'Laden‚Ä¶';
    try{
      const d = await get('/jobs/' + id);
      $('#jobDetail').textContent = JSON.stringify(d, null, 2);
    }catch(e){
      $('#jobDetail').textContent = 'Fout: ' + e.message;
    }
  }

  async function sendJob(){
    setMsg($('#sendMsg'),'Versturen‚Ä¶');
    $('#resultOut').textContent = '-';
    try{
      let payload;
      try{
        payload = JSON.parse($('#payloadTxt').value || '{}');
      }catch(e){
        throw new Error('JSON parse error: ' + e.message);
      }
      if(!payload || !payload.task) throw new Error('Payload moet een "task" bevatten.');

      const j = await api('/jobs/create', payload);
      $('#resultOut').textContent = JSON.stringify(j, null, 2);
      setMsg($('#sendMsg'),'Job aangemaakt', true);

      // Poll de job tot einde
      if(j.job_id){
        clearInterval(pollTimer);
        pollTimer = setInterval(refreshJobs, 1500);
      }
      await refreshJobs();
    }catch(e){
      setMsg($('#sendMsg'),'Fout: ' + e.message, false);
      $('#resultOut').textContent = e.message;
    }
  }

  async function selftest(){
    $('#resultOut').textContent = 'Selftest bezig‚Ä¶';
    try{
      const r = await get('/health'); // laat o.a. taken zien in sommige implementaties
      $('#resultOut').textContent = JSON.stringify(r, null, 2);
    }catch(e){
      $('#resultOut').textContent = 'Fout: ' + e.message;
    }
  }

  // ---------- Wire up ----------
  $('#saveBtn').onclick = saveSettings;
  $('#healthBtn').onclick = doHealth;
  $('#sendBtn').onclick = sendJob;
  $('#selftestBtn').onclick = selftest;
  $('#refreshJobs').onclick = refreshJobs;

  // Init load
  loadSettings();
  refreshJobs();
  // eerste keer: toon weekly template zodat het "direct werkt"
  if(!$('#payloadTxt').value) $('#payloadTxt').value = tplWeekly();
</script>
</body>
</html>
