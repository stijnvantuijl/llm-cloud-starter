<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <title>LLM Control Panel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --bg:#0b1020; --card:#141a2f; --muted:#99a3b3; --text:#eaf1ff; --accent:#6ea8fe; --ok:#29cc7a; --warn:#ffbf3c; --err:#ff6b6b; }
    * { box-sizing: border-box; }
    html,body { margin:0; padding:0; background:var(--bg); color:var(--text); font:14px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    h1 { font-size:20px; margin:0 0 12px; }
    h2 { font-size:16px; margin:0 0 10px; }
    small { color:var(--muted); }
    a { color: var(--accent); text-decoration: none; }
    .wrap { max-width:1100px; margin:24px auto; padding:0 16px; }
    .grid { display:grid; gap:16px; grid-template-columns: 1.2fr 1fr; }
    .card { background:var(--card); border:1px solid #202845; border-radius:12px; padding:16px; }
    .row { display:flex; gap:8px; align-items:center; }
    .row > * { flex:1; }
    label { display:block; font-size:12px; color:var(--muted); margin-bottom:6px; }
    input, textarea, select {
      width:100%; background:#0f1530; color:var(--text);
      border:1px solid #233055; border-radius:8px;
      padding:10px 12px; outline:none;
    }
    textarea { min-height:120px; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; }
    .btn {
      appearance:none; border:0; padding:10px 14px; border-radius:10px;
      background:#2a3a73; color:var(--text); font-weight:600; cursor:pointer;
    }
    .btn.secondary { background:#26335f; }
    .btn.ok { background:#12633f; }
    .btn.warn { background:#7a5400; }
    .btn:disabled { opacity:0.6; cursor:not-allowed; }
    .muted { color:var(--muted); }
    .mono { font-family: ui-monospace, Menlo, Consolas, monospace; }
    .kv { background:#0f1530; border:1px solid #233055; border-radius:8px; padding:10px; white-space:pre-wrap; }
    .jobs { display:grid; gap:10px; }
    .job { padding:12px; border:1px solid #22305a; border-radius:10px; background:#101633; }
    .status { font-size:12px; padding:2px 8px; border-radius:999px; margin-left:8px; }
    .running { background:#233055; color:#9ec1ff; }
    .done { background:#123a2b; color:#8be4b1; }
    .failed { background:#4b1f27; color:#ff9aa6; }
    .pill { display:inline-block; padding:2px 8px; background:#22305a; border-radius:999px; font-size:12px; }
    .help { color:var(--muted); font-size:12px; margin-top:6px; }
    .hr { height:1px; background:#202845; margin:12px 0; border:0; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>LLM Control Panel <small class="muted">– beheer API, jobs & commits</small></h1>

    <div class="grid">
      <!-- Linkerkolom: instellingen + chat/test + jobs -->
      <div class="col">
        <div class="card">
          <h2>Instellingen</h2>
          <div class="row">
            <div>
              <label>API Base URL</label>
              <input id="baseUrl" placeholder="https://llm-cloud-starter.onrender.com" />
              <div class="help">Tip: standaard wordt <span class="mono">window.location.origin</span> gebruikt.</div>
            </div>
            <div>
              <label>X-API-Key</label>
              <input id="apiKey" type="password" placeholder="plak hier je access key" />
              <div class="help">Wordt alleen lokaal opgeslagen (localStorage).</div>
            </div>
          </div>
          <div class="row" style="margin-top:8px">
            <button class="btn" id="saveBtn">Opslaan</button>
            <button class="btn secondary" id="healthBtn">Health check</button>
          </div>
          <div id="healthOut" class="help" style="margin-top:8px"></div>
        </div>

        <div class="card">
          <h2>Snelle test (job “summarize”)</h2>
          <textarea id="testText" placeholder="Typ wat tekst die samengevat mag worden…"></textarea>
          <div class="row" style="margin-top:8px">
            <button class="btn" id="startTestBtn">Start test</button>
            <button class="btn secondary" id="refreshJobsBtn">Ververs jobs</button>
          </div>
        </div>

        <div class="card">
          <h2>Jobs</h2>
          <div id="jobs" class="jobs">
            <div class="help">Laden…</div>
          </div>
        </div>
      </div>

      <!-- Rechterkolom: commit naar GitHub -->
      <div class="col">
        <div class="card">
          <h2>Commit bestand naar GitHub</h2>
          <label>Repo (owner/name)</label>
          <input id="repo" placeholder="stijnvantuijl/llm-cloud-starter" />

          <label style="margin-top:10px;">Pad (bijv. <span class="mono">apps/bekendmakingen/example.py</span>)</label>
          <input id="path" placeholder="apps/bekendmakingen/example.py" />

          <label style="margin-top:10px;">Commit message</label>
          <input id="message" value="Add file via API" />

          <label style="margin-top:10px;">Branch</label>
          <input id="branch" value="main" />

          <label style="margin-top:10px;">Bestandsinhoud</label>
          <textarea id="content" placeholder="print('Hallo! Dit bestand is via de API gecommit.')"></textarea>

          <div class="row" style="margin-top:10px;">
            <button class="btn ok" id="commitBtn">Commit</button>
            <button class="btn secondary" id="prefillBtn">Voorbeeld vullen</button>
          </div>
          <div id="commitOut" class="help" style="margin-top:8px;"></div>
          <hr class="hr" />
          <div class="help">
            Deze actie roept <span class="mono">POST /jobs/create</span> aan met
            <span class="pill">task: commit_file</span>. De backend voert de commit uit (met jouw GitHub token dat daar is geconfigureerd).
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ---------- Helpers ----------
    const $ = sel => document.querySelector(sel);
    const sleep = (ms) => new Promise(r => setTimeout(r, ms));

    function getBase() {
      const local = localStorage.getItem('apiBaseUrl');
      return (local && local.trim()) || window.location.origin;
    }
    function getKey() {
      return localStorage.getItem('apiKey') || '';
    }

    async function api(path, opts = {}) {
      const headers = Object.assign({
        'Content-Type': 'application/json',
        'X-API-Key': getKey()
      }, (opts.headers || {}));
      const res = await fetch(`${getBase()}${path}`, { ...opts, headers });
      const txt = await res.text();
      let data;
      try { data = txt ? JSON.parse(txt) : {}; } catch { data = { raw: txt }; }
      if (!res.ok) throw Object.assign(new Error('API error'), { status: res.status, data });
      return data;
    }

    function statusBadge(s) {
      const cls = s === 'done' ? 'done' : s === 'failed' ? 'failed' : 'running';
      return `<span class="status ${cls}">${s}</span>`;
    }

    // ---------- UI logica ----------
    async function loadSettings() {
      $('#baseUrl').value = getBase();
      $('#apiKey').value = getKey();
    }

    async function saveSettings() {
      localStorage.setItem('apiBaseUrl', $('#baseUrl').value.trim());
      localStorage.setItem('apiKey', $('#apiKey').value.trim());
      alert('Opgeslagen ✔');
    }

    async function healthCheck() {
      $('#healthOut').textContent = 'Bezig…';
      try {
        // kleine ping via GET / (wordt 307 naar /ui/control.html) of gebruik /jobs
        await fetch(getBase(), { method: 'GET' });
        $('#healthOut').textContent = 'Server bereikbaar ✅';
      } catch (e) {
        $('#healthOut').textContent = 'Server niet bereikbaar ❌';
      }
    }

    function renderJobs(jobs) {
      const box = $('#jobs');
      if (!jobs || Object.keys(jobs).length === 0) {
        box.innerHTML = `<div class="help">Geen jobs gevonden.</div>`;
        return;
      }
      box.innerHTML = '';
      Object.entries(jobs).reverse().forEach(([id, j]) => {
        const el = document.createElement('div');
        el.className = 'job';
        el.innerHTML = `
          <div class="row" style="justify-content:space-between; align-items:baseline;">
            <div><strong>${j.task}</strong> ${statusBadge(j.status)}</div>
            <div class="muted mono">${id}</div>
          </div>
          ${j.result ? `<div class="kv" style="margin-top:8px;">${JSON.stringify(j.result, null, 2)}</div>` : ''}
        `;
        box.appendChild(el);
      });
    }

    async function refreshJobs() {
      $('#jobs').innerHTML = `<div class="help">Laden…</div>`;
      try {
        const data = await api('/jobs', { method: 'GET' });
        renderJobs(data);
      } catch (e) {
        $('#jobs').innerHTML = `<div class="help">Kon jobs niet laden (${e.status || ''}).</div>`;
      }
    }

    async function startTestJob() {
      const text = $('#testText').value.trim() || 'Dit is een snelle test.';
      // 1) aanmaken
      const create = await api('/jobs/create', {
        method: 'POST',
        body: JSON.stringify({ task: 'summarize', payload: { text } })
      });
      const job_id = create.job_id;
      // 2) poll tot klaar
      for (;;) {
        const j = await api(`/jobs/${job_id}`, { method: 'GET' });
        if (j.status === 'done' || j.status === 'failed') break;
        await sleep(1200);
      }
      await refreshJobs();
      alert('Testjob afgerond.');
    }

    async function commitFile() {
      const repo = $('#repo').value.trim();
      const path = $('#path').value.trim();
      const message = $('#message').value.trim();
      const branch = $('#branch').value.trim();
      const content = $('#content').value;

      if (!repo || !path) { alert('Vul repo en pad in.'); return; }

      $('#commitOut').textContent = 'Committen…';
      try {
        const data = await api('/jobs/create', {
          method: 'POST',
          body: JSON.stringify({
            task: 'commit_file',
            payload: { repo, path, message, branch, content }
          })
        });
        $('#commitOut').textContent = `Ingediend. Job-ID: ${data.job_id}`;
        await refreshJobs();
      } catch (e) {
        $('#commitOut').textContent = `Fout (${e.status || ''}): ${JSON.stringify(e.data || {}, null, 2)}`;
      }
    }

    function prefillExample() {
      $('#repo').value = 'stijnvantuijl/llm-cloud-starter';
      $('#path').value = 'apps/bekendmakingen/example.py';
      $('#message').value = 'Add example via API';
      $('#branch').value = 'main';
      $('#content').value =
`print("Voorbeeldbestand via API")
from datetime import datetime
print("Timestamp:", datetime.utcnow().isoformat())`;
    }

    // ---------- Init ----------
    (function init() {
      loadSettings();
      refreshJobs();

      $('#saveBtn').addEventListener('click', saveSettings);
      $('#healthBtn').addEventListener('click', healthCheck);
      $('#refreshJobsBtn').addEventListener('click', refreshJobs);
      $('#startTestBtn').addEventListener('click', startTestJob);
      $('#commitBtn').addEventListener('click', commitFile);
      $('#prefillBtn').addEventListener('click', prefillExample);
    })();
  </script>
</body>
</html>
