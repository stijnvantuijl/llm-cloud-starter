<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Command Center (Natuurlijk Taal)</title>
  <style>
    body { font-family: system-ui, Arial, sans-serif; margin: 0; background:#0b1020; color:#e9edf7; }
    header { display:flex; gap:12px; padding:16px; align-items:center; background:#111735; position:sticky; top:0; z-index:10; }
    header h1 { margin:0; font-size:18px; font-weight:600; }
    .row { display:flex; gap:16px; padding:16px; flex-wrap:wrap; }
    .card { background:#121a3a; border:1px solid #1f2a56; border-radius:14px; padding:14px; box-shadow:0 0 0 1px #1a244c inset; }
    .w30 { flex:1 1 320px; max-width:420px; }
    .w70 { flex: 1 1 540px; min-width:420px; }
    label { display:block; font-size:12px; color:#aab7ff; margin-bottom:6px; }
    input[type="text"], input[type="url"], textarea, select {
      width:100%; box-sizing:border-box; background:#0e1530; color:#e9edf7; border:1px solid #223069;
      padding:10px 12px; border-radius:10px; outline:none;
    }
    textarea { min-height:120px; resize:vertical; }
    button { background:#2d47ff; color:white; border:none; border-radius:10px; padding:10px 14px; cursor:pointer; font-weight:600; }
    button.secondary { background:#0e1530; border:1px solid #223069; color:#c9d6ff; }
    .flex { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .pill { background:#0e1530; border:1px solid #223069; color:#aab7ff; border-radius:999px; padding:6px 10px; font-size:12px; }
    .chat { display:flex; flex-direction:column; gap:10px; }
    .msg { padding:12px; border-radius:12px; white-space:pre-wrap; }
    .user { background:#1a254f; border:1px solid #2a3d8c; align-self:flex-end; max-width:80%; }
    .bot { background:#0f1836; border:1px solid #223069; align-self:flex-start; max-width:90%; }
    .muted { color:#9fb0ff; font-size:12px; }
    .mono { font-family: ui-monospace, Menlo, Consolas, monospace; }
    .hr { height:1px; background:#1f2a56; margin:10px 0; }
    .grid2 { display:grid; grid-template-columns:1fr 1fr; gap:8px; }
    .small { font-size:12px; }
    .badge { display:inline-block; padding:2px 8px; border:1px solid #2a3d8c; border-radius:999px; font-size:11px; color:#aab7ff; margin-left:8px;}
    .btn-inline { margin-left:6px; padding:6px 10px; font-size:12px;}
  </style>
</head>
<body>
  <header>
    <h1>Command Center</h1>
    <a class="pill" href="/ui/control.html">üîß Control</a>
    <a class="pill" href="/ui/assistant.html">üí¨ Assistant</a>
  </header>

  <div class="row">
    <!-- Instellingen -->
    <div class="card w30">
      <h3>Instellingen</h3>
      <label>API Base URL</label>
      <input id="baseUrl" type="url" placeholder="https://llm-cloud-starter.onrender.com" />
      <div style="height:8px"></div>
      <label>X-API-Key</label>
      <input id="apiKey" type="text" placeholder="plak hier je access key" />
      <div style="height:10px"></div>
      <div class="flex">
        <button id="saveBtn">Opslaan</button>
        <button class="secondary" id="healthBtn">Health check</button>
        <span id="healthOut" class="muted small"></span>
      </div>
      <div class="hr"></div>
      <div class="grid2 small">
        <div>
          <label>Repo (owner/name)</label>
          <input id="repo" type="text" placeholder="stijnvantuijl/llm-cloud-starter" />
        </div>
        <div>
          <label>Prefix (map)</label>
          <input id="prefix" type="text" placeholder="apps/bekendmakingen/" />
        </div>
        <div>
          <label>Branch</label>
          <input id="branch" type="text" placeholder="main" />
        </div>
        <div>
          <label>Max files</label>
          <input id="maxFiles" type="text" placeholder="10" />
        </div>
      </div>
      <div class="hr"></div>
      <p class="small muted">
        Alles wordt opgeslagen in <span class="mono">localStorage</span>.
      </p>
    </div>

    <!-- Chat/commando's -->
    <div class="card w70">
      <h3>Praat met de API <span class="badge">pure JSON / dry-run suggesties</span></h3>
      <div class="chat" id="chat"></div>
      <div style="height:10px"></div>
      <label for="input">Je instructie (bijv. ‚ÄúVat samen: ‚Ä¶‚Äù, ‚ÄúDraai bekendmakingen‚Äù, ‚ÄúBuild: {JSON}‚Äù, of gewoon vrij NL)</label>
      <textarea id="input" placeholder="Schrijf hier in gewone taal wat je wilt dat de API doet‚Ä¶"></textarea>
      <div class="flex" style="margin-top:8px">
        <button id="sendBtn">Versturen</button>
        <button class="secondary" id="suggestBtn">Suggestie vragen</button>
        <button class="secondary" id="clearBtn">Wis gesprek</button>
        <span id="status" class="muted small"></span>
      </div>

      <div class="hr"></div>
      <details>
        <summary>üß† Begrijpbare commando‚Äôs (klik om te openen)</summary>
        <ul class="small">
          <li><b>Samenvatten</b>: ‚ÄúVat samen: &lt;tekst&gt;‚Äù</li>
          <li><b>Bekendmakingen</b>: ‚ÄúDraai bekendmakingen dry-run‚Äù of ‚ÄúDraai bekendmakingen‚Äù</li>
          <li><b>Build</b>: ‚ÄúBuild: { ...puur JSON spec... }‚Äù</li>
          <li><b>Commit</b>: ‚ÄúCommit pad=‚Ä¶ branch=main message=‚Ä¶ inhoud=‚Ä¶.‚Äù</li>
          <li><b>Suggestie</b>: typ vrij NL, klik <i>Suggestie vragen</i> ‚Üí API geeft rooktest/dry-run voorstel in puur JSON</li>
        </ul>
      </details>
    </div>
  </div>

  <script>
    // ---------- helpers ----------
    const $ = (sel) => document.querySelector(sel);
    function saveSettings() {
      localStorage.setItem('baseUrl', $('#baseUrl').value.trim());
      localStorage.setItem('x_api_key', $('#apiKey').value.trim());
      localStorage.setItem('repo', $('#repo').value.trim());
      localStorage.setItem('prefix', $('#prefix').value.trim());
      localStorage.setItem('branch', $('#branch').value.trim());
      localStorage.setItem('maxFiles', $('#maxFiles').value.trim());
      $('#status').textContent = 'Instellingen opgeslagen.';
      setTimeout(() => $('#status').textContent = '', 1500);
    }
    function loadSettings() {
      $('#baseUrl').value = localStorage.getItem('baseUrl') || location.origin.replace(/\/ui.*/,'');
      $('#apiKey').value  = localStorage.getItem('x_api_key') || '';
      $('#repo').value    = localStorage.getItem('repo') || 'stijnvantuijl/llm-cloud-starter';
      $('#prefix').value  = localStorage.getItem('prefix') || 'apps/bekendmakingen/';
      $('#branch').value  = localStorage.getItem('branch') || 'main';
      $('#maxFiles').value= localStorage.getItem('maxFiles') || '10';
    }
    function addMsg(role, text, html=false) {
      const div = document.createElement('div');
      div.className = `msg ${role==='user'?'user':'bot'}`;
      if (html) div.innerHTML = text; else div.textContent = text;
      $('#chat').appendChild(div);
      div.scrollIntoView({behavior:'smooth', block:'end'});
    }
    async function api(path, opts={}) {
      const base = ($('#baseUrl').value || '').trim();
      const key  = ($('#apiKey').value || '').trim();
      if (!base || !key) throw new Error('Vul Base URL en X-API-Key in (en klik Opslaan).');
      const res = await fetch(`${base}${path}`, {
        ...opts,
        headers: {
          'Content-Type': 'application/json',
          'X-API-Key': key,
          ...(opts.headers||{})
        }
      });
      if (!res.ok) {
        const t = await res.text().catch(()=> '');
        throw new Error(`API ${res.status}: ${t || res.statusText}`);
      }
      return res.json();
    }
    async function createJob(task, payload) {
      return api('/jobs/create', { method: 'POST', body: JSON.stringify({ task, payload }) });
    }
    async function pollJob(job_id, onUpdate) {
      const base = ($('#baseUrl').value || '').trim();
      const key  = ($('#apiKey').value || '').trim();
      while (true) {
        const r = await fetch(`${base}/jobs/${job_id}`, { headers: { 'X-API-Key': key } });
        const j = await r.json();
        onUpdate?.(j);
        if (j.status === 'done' || j.status === 'failed' || j.status === 'error') return j;
        await new Promise(r => setTimeout(r, 1000));
      }
    }

    // ---------- intent mapping (handmatig) ----------
    function detectIntent(text) {
      const t = text.trim(); const low = t.toLowerCase();

      const buildMatch = t.match(/^build\s*:\s*({[\s\S]+})\s*$/i);
      if (buildMatch) {
        try { return { kind:'build', spec: JSON.parse(buildMatch[1]) }; }
        catch { return { kind:'error', message:'De build-spec is geen geldige JSON.' }; }
      }
      if (low.startsWith('commit')) {
        const mPad=t.match(/pad\s*=\s*([^\s]+)/i);
        const mBranch=t.match(/branch\s*=\s*([^\s]+)/i);
        const mMsg=t.match(/message\s*=\s*([^]+?)\s+(?:inhoud=|content=)/i);
        const mBody=t.match(/(?:inhoud|content)\s*=\s*([^]+)$/i);
        if (!mPad || !mBody) return { kind:'error', message:'Commit: minimaal pad=‚Ä¶ en inhoud=‚Ä¶ nodig.' };
        return { kind:'commit', path:mPad[1], branch:(mBranch && mBranch[1])||($('#branch').value||'main'),
                 message:(mMsg && mMsg[1].trim())||'commit via assistant', content:mBody[1] };
      }
      if (low.includes('bekendmaking')) {
        const dry = /dry[-\s]?run|test/.test(low);
        return { kind:'bekendmakingen', dry_run: dry };
      }
      const sumMatch = t.match(/^(?:vat\s+samen|samenvat|samenvatten)\s*:\s*([^]+)$/i);
      if (sumMatch) return { kind:'summarize', text: sumMatch[1].trim() };
      if (t.length > 30) return { kind:'summarize', text: t };
      return { kind:'unknown', raw: t };
    }

    // ---------- acties ----------
    async function handleUserInput() {
      const txt = ($('#input').value || '').trim();
      if (!txt) return;
      addMsg('user', txt);
      $('#input').value = '';
      $('#status').textContent = 'Aan het verwerken‚Ä¶';

      const intent = detectIntent(txt);
      const repo   = ($('#repo').value || '').trim();
      const prefix = ($('#prefix').value || '').trim();
      const branch = ($('#branch').value || 'main').trim();
      const maxFiles = parseInt($('#maxFiles').value || '10', 10);

      try {
        if (intent.kind === 'error') {
          addMsg('bot', `‚ö†Ô∏è ${intent.message}`);
        } else if (intent.kind === 'summarize') {
          const { job_id } = await createJob('summarize', { text: intent.text });
          const done = await pollJob(job_id);
          addMsg('bot', done?.result?.summary || JSON.stringify(done));
        } else if (intent.kind === 'bekendmakingen') {
          const { job_id } = await createJob('weekly_bekendmakingen', { dry_run: !!intent.dry_run });
          const done = await pollJob(job_id);
          addMsg('bot', 'Bekendmakingen job: ' + JSON.stringify(done?.result || done));
        } else if (intent.kind === 'build') {
          const spec = intent.spec || {};
          const payload = {
            repo, prefix, branch, max_files: maxFiles,
            ...(spec.goal ? { goal: spec.goal } : {}),
            ...(spec.files ? { files: spec.files } : {}),
            ...(spec.commit_message ? { message: spec.commit_message } : {})
          };
          const { job_id } = await createJob('build_from_spec', payload);
          const done = await pollJob(job_id);
          addMsg('bot', 'Build result: ' + JSON.stringify(done?.result || done));
        } else if (intent.kind === 'commit') {
          const { job_id } = await createJob('commit_file', {
            repo, path: (prefix ? (prefix + intent.path) : intent.path),
            message: intent.message, branch: intent.branch, content: intent.content
          });
          const done = await pollJob(job_id);
          addMsg('bot', 'Commit: ' + JSON.stringify(done?.result || done));
        } else {
          addMsg('bot', 'Ik snapte dit niet helemaal. Probeer: ‚ÄúVat samen: ‚Ä¶‚Äù, ‚ÄúDraai bekendmakingen (dry-run)‚Äù, ‚ÄúBuild: {‚Ä¶}‚Äù, of klik op ‚ÄúSuggestie vragen‚Äù.');
        }
      } catch (err) {
        addMsg('bot', '‚ùå Fout: ' + (err?.message || err));
      } finally {
        $('#status').textContent = '';
      }
    }

    async function handleSuggest() {
      const txt = ($('#input').value || '').trim();
      if (!txt) { addMsg('bot', 'Typ eerst wat je wilt en klik dan Suggestie.'); return; }
      addMsg('user', 'Suggestie voor: ' + txt);
      $('#status').textContent = 'Vraag suggestie (rooktest/dry-run)‚Ä¶';

      try {
        const { job_id } = await createJob('suggest', { prompt: txt });
        const done = await pollJob(job_id);
        if (!done?.result?.ok) {
          addMsg('bot', '‚ùå Suggestie mislukt: ' + JSON.stringify(done?.result || done));
          $('#status').textContent = '';
          return;
        }
        const sug = done.result.suggestion;
        const pretty = JSON.stringify(sug, null, 2);
        addMsg('bot', 'Voorstel (JSON):\n' + pretty);

        // Bied direct uitvoeren aan
        const execHtml = `
          <div>Wil je dit uitvoeren?
            <button class="btn-inline" id="execBtn">Uitvoeren</button>
          </div>`;
        addMsg('bot', execHtml, true);

        // attach listener √©√©nmalig
        setTimeout(() => {
          const btn = document.getElementById('execBtn');
          if (!btn) return;
          btn.onclick = async () => {
            try {
              $('#status').textContent = 'Uitvoeren‚Ä¶';
              if (sug.type === 'build') {
                const repo   = ($('#repo').value || '').trim();
                const prefix = ($('#prefix').value || '').trim();
                const branch = ($('#branch').value || 'main').trim();
                const maxFiles = parseInt($('#maxFiles').value || '10', 10);
                const payload = {
                  repo, prefix, branch, max_files: maxFiles,
                  ...(sug.payload.goal ? { goal: sug.payload.goal } : {}),
                  ...(sug.payload.files ? { files: sug.payload.files } : {}),
                  ...(sug.payload.commit_message ? { message: sug.payload.commit_message } : {})
                };
                const { job_id } = await createJob('build_from_spec', payload);
                const done2 = await pollJob(job_id);
                addMsg('bot', 'Build result: ' + JSON.stringify(done2?.result || done2));
              } else if (sug.type === 'job') {
                const { job_id } = await createJob(sug.payload.task, sug.payload.payload || {});
                const done2 = await pollJob(job_id);
                addMsg('bot', 'Job result: ' + JSON.stringify(done2?.result || done2));
              } else if (sug.type === 'commit') {
                const repo   = ($('#repo').value || '').trim();
                const prefix = ($('#prefix').value || '').trim();
                const p = sug.payload;
                const { job_id } = await createJob('commit_file', {
                  repo,
                  path: (prefix ? (prefix + p.path) : p.path),
                  branch: p.branch || ($('#branch').value || 'main'),
                  message: p.message || 'commit via suggest',
                  content: p.content || ''
                });
                const done2 = await pollJob(job_id);
                addMsg('bot', 'Commit result: ' + JSON.stringify(done2?.result || done2));
              } else {
                addMsg('bot', 'Onbekend suggestie-type: ' + sug.type);
              }
            } catch (e) {
              addMsg('bot', '‚ùå Uitvoer-fout: ' + (e?.message || e));
            } finally {
              $('#status').textContent = '';
            }
          };
        }, 0);

      } catch (e) {
        addMsg('bot', '‚ùå Fout bij suggestie: ' + (e?.message || e));
      } finally {
        $('#status').textContent = '';
      }
    }

    // events
    $('#saveBtn').onclick = saveSettings;
    $('#healthBtn').onclick = async () => {
      try {
        const j = await api('/health');
        $('#healthOut').textContent = 'OK ' + JSON.stringify(j);
      } catch (e) {
        $('#healthOut').textContent = 'Fout: ' + e.message;
      }
    };
    $('#sendBtn').onclick = handleUserInput;
    $('#suggestBtn').onclick = handleSuggest;
    $('#clearBtn').onclick = () => { $('#chat').innerHTML = ''; };

    $('#input').addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && (e.metaKey || e.ctrlKey)) handleUserInput();
    });

    loadSettings();
  </script>
</body>
</html>
